#!/usr/bin/env -S uv run --script
#
# /// script
# requires-python = ">=3.12"
# dependencies = ["minijinja"]
# ///

import sys
import re
from datetime import datetime
from pathlib import Path
from minijinja import Environment

POST_SOURCE = """+++
title = "{{ title }}"
draft = true
date = {{ date }}
description = ""
tags = [ "thoughts"]

+++

Text
"""

def slugify(text):
    """Convert text to a URL-friendly slug."""
    # Convert to lowercase
    text = text.lower()
    # Replace spaces and underscores with hyphens
    text = re.sub(r'[\s_]+', '-', text)
    # Remove non-alphanumeric characters except hyphens
    text = re.sub(r'[^\w\-]', '', text)
    # Remove multiple consecutive hyphens
    text = re.sub(r'\-+', '-', text)
    # Strip leading/trailing hyphens
    text = text.strip('-')
    return text

# Get title from command line arguments or use default
title = ' '.join(sys.argv[1:]) if len(sys.argv) > 1 else "New Post"

# Get current date in YYYY-MM-DD format
date = datetime.now().strftime("%Y-%m-%d")

env = Environment(templates={
    "new_post": POST_SOURCE
})

result = env.render_template('new_post', date=date, title=title)

# Create slugified filename
slug = slugify(title)
new_filename = Path("content/blog") / f"{date}-{slug}.md"

# Ensure the directory exists
new_filename.parent.mkdir(parents=True, exist_ok=True)

with open(new_filename, 'w') as fd:
    fd.write(result)

print(f"Created new blog post: {new_filename}")
